name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  XCODE_VERSION: '16.4'
  IOS_SIMULATOR: 'iPhone 15 Pro'
  MACOS_VERSION: 'macOS 15.5'

jobs:
  test:
    name: Run Tests
    runs-on: macos-15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer
      
    - name: Show Xcode version
      run: xcodebuild -version
      
    - name: Cache derived data
      uses: actions/cache@v4
      with:
        path: ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-derived-data-${{ hashFiles('**/*.xcodeproj/project.pbxproj') }}
        restore-keys: |
          ${{ runner.os }}-derived-data-
    
    - name: Install dependencies
      run: |
        # 如果使用 Swift Package Manager，这里会自动解析依赖
        echo "Dependencies will be resolved automatically by Xcode"
    
    - name: Build for testing
      run: |
        xcodebuild clean build-for-testing \
          -project Icons.xcodeproj \
          -scheme Icons \
          -destination 'platform=macOS,arch=x86_64' \
          -configuration Debug \
          CODE_SIGNING_ALLOWED=NO
    
    - name: Run unit tests
      run: |
        xcodebuild test-without-building \
          -project Icons.xcodeproj \
          -scheme Icons \
          -destination 'platform=macOS,arch=x86_64' \
          -configuration Debug \
          CODE_SIGNING_ALLOWED=NO
    
    - name: Run UI tests
      run: |
        xcodebuild test \
          -project Icons.xcodeproj \
          -scheme Icons \
          -destination 'platform=macOS,arch=x86_64' \
          -configuration Debug \
          -testPlan IconsUITests \
          CODE_SIGNING_ALLOWED=NO
      continue-on-error: true  # UI tests may fail in CI environment

  code-quality:
    name: Code Quality Checks
    runs-on: macos-15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer
    
    - name: Install SwiftLint
      run: |
        brew install swiftlint
    
    - name: Run SwiftLint
      run: |
        swiftlint lint --reporter github-actions-logging
      continue-on-error: true
    
    - name: Run SwiftFormat (check only)
      run: |
        brew install swiftformat
        swiftformat --lint Icons/
      continue-on-error: true

  build:
    name: Build Release
    runs-on: macos-15
    needs: [test, code-quality]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer
    
    - name: Cache derived data
      uses: actions/cache@v4
      with:
        path: ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-derived-data-${{ hashFiles('**/*.xcodeproj/project.pbxproj') }}
        restore-keys: |
          ${{ runner.os }}-derived-data-
    
    - name: Build for release
      run: |
        xcodebuild clean build \
          -project Icons.xcodeproj \
          -scheme Icons \
          -destination 'platform=macOS,arch=x86_64' \
          -configuration Release \
          CODE_SIGNING_ALLOWED=NO
    
    - name: Archive application
      run: |
        xcodebuild archive \
          -project Icons.xcodeproj \
          -scheme Icons \
          -destination 'platform=macOS,arch=x86_64' \
          -configuration Release \
          -archivePath build/Icons.xcarchive \
          CODE_SIGNING_ALLOWED=NO
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Icons-Archive
        path: build/Icons.xcarchive
        retention-days: 30

  security-scan:
    name: Security Scan
    runs-on: macos-15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run security scan
      run: |
        # 检查敏感信息泄露
        echo "Scanning for sensitive information..."
        
        # 检查是否有硬编码的API密钥
        if grep -r "sk-" Icons/ --include="*.swift" --include="*.plist"; then
          echo "⚠️ Warning: Potential API keys found in code"
          exit 1
        fi
        
        # 检查是否有硬编码的密码
        if grep -ri "password.*=" Icons/ --include="*.swift" --include="*.plist"; then
          echo "⚠️ Warning: Potential hardcoded passwords found"
          exit 1
        fi
        
        echo "✅ Security scan passed"

  dependency-check:
    name: Dependency Security Check
    runs-on: macos-15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check Swift Package dependencies
      run: |
        echo "Checking Swift Package dependencies for security vulnerabilities..."
        
        # 如果项目使用 Package.swift，检查依赖
        if [ -f "Package.swift" ]; then
          swift package show-dependencies
        fi
        
        # 检查 Xcode 项目的 Swift Package 依赖
        if [ -f "Icons.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved" ]; then
          echo "Found Package.resolved, checking dependencies..."
          cat Icons.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved
        fi
        
        echo "✅ Dependency check completed"